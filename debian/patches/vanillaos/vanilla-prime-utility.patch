From: Debian GNOME Maintainers
 <pkg-gnome-maintainers@lists.alioth.debian.org>
Date: Thu, 22 May 2025 10:42:33 -0500
Subject: vanilla-prime-utility

---
 panels/display/cc-display-panel.blp | 15 +++++++++++++++
 panels/display/cc-display-panel.c   | 36 ++++++++++++++++++++++++++++++++++++
 2 files changed, 51 insertions(+)

diff --git a/panels/display/cc-display-panel.blp b/panels/display/cc-display-panel.blp
index f40b2cf..a179c32 100644
--- a/panels/display/cc-display-panel.blp
+++ b/panels/display/cc-display-panel.blp
@@ -117,6 +117,21 @@ template $CcDisplayPanel: $CcPanel {
             action-target: "'night-light'";
           }
         }
+
+        Adw.PreferencesGroup {
+          Adw.ActionRow prime_utility_row {
+            title: _("GPU Profile Management (PRIME)");
+            activatable: true;
+            use-underline: true;
+            activated => $c_display_panel_prime(template);
+
+            [suffix]
+            Gtk.Image {
+              icon-name: "adw-external-link-symbolic";
+              valign: center;
+            }
+          }
+        }
       };
     };
   }
diff --git a/panels/display/cc-display-panel.c b/panels/display/cc-display-panel.c
index d9de82c..d6beb69 100644
--- a/panels/display/cc-display-panel.c
+++ b/panels/display/cc-display-panel.c
@@ -97,6 +97,7 @@ struct _CcDisplayPanel
   AdwNavigationPage *display_settings_page;
   AdwComboRow    *primary_display_row;
   AdwPreferencesGroup *single_display_settings_group;
+  AdwPreferencesGroup *prime_utility_row;
 
   GtkShortcut *escape_shortcut;
 
@@ -541,6 +542,37 @@ on_toplevel_escape_pressed_cb (GtkWidget      *widget,
   return GDK_EVENT_PROPAGATE;
 }
 
+static gboolean
+does_prime_utility_exist (void)
+{
+  g_autofree gchar *path = g_find_program_in_path ("vanilla-prime-utility");
+  return path != NULL;
+}
+
+static void
+cc_display_panel_prime (CcDisplayPanel *self)
+{
+  g_autoptr (GError) error = NULL;
+  gboolean ret;
+  char *argv[3];
+
+  if (does_prime_utility_exist ())
+    {
+      argv[0] = "vanilla-prime-utility";
+      argv[1] = "--embedded";
+      argv[2] = NULL;
+    }
+  else
+    {
+      g_warning ("Vanilla prime utility not found!");
+      return;
+    }
+
+  ret = g_spawn_async (NULL, argv, NULL, G_SPAWN_SEARCH_PATH, NULL, NULL, NULL, &error);
+  if (!ret)
+    g_warning ("Failed to spawn %s: %s", argv[0], error->message);
+}
+
 static void
 cc_display_panel_constructed (GObject *object)
 {
@@ -611,6 +643,7 @@ cc_display_panel_class_init (CcDisplayPanelClass *klass)
   gtk_widget_class_bind_template_callback (widget_class, on_primary_display_selected_item_changed_cb);
   gtk_widget_class_bind_template_callback (widget_class, on_screen_changed);
   gtk_widget_class_bind_template_callback (widget_class, on_toplevel_escape_pressed_cb);
+  gtk_widget_class_bind_template_callback (widget_class, cc_display_panel_prime);
 }
 
 static void
@@ -1100,6 +1133,9 @@ cc_display_panel_init (CcDisplayPanel *self)
   else
     g_clear_object (&self->up_client);
 
+  if (!does_prime_utility_exist ())
+    gtk_widget_set_visible (GTK_WIDGET (self->prime_utility_row), false);
+
   g_signal_connect (self, "map", G_CALLBACK (mapped_cb), NULL);
 
   cc_object_storage_create_dbus_proxy (G_BUS_TYPE_SESSION,
