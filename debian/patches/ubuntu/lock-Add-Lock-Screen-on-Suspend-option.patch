From: Tim Lunn <tim@feathertop.org>
Date: Mon, 3 Jun 2013 17:27:45 +1000
Subject: lock: Add "Lock Screen on Suspend" option

https://launchpad.net/bugs/938076
---
 panels/privacy/screen/cc-screen-page.blp |  5 +++++
 panels/privacy/screen/cc-screen-page.c   | 20 ++++++++++++++++++++
 2 files changed, 25 insertions(+)

diff --git a/panels/privacy/screen/cc-screen-page.blp b/panels/privacy/screen/cc-screen-page.blp
index 6367683..18a25e3 100644
--- a/panels/privacy/screen/cc-screen-page.blp
+++ b/panels/privacy/screen/cc-screen-page.blp
@@ -60,6 +60,11 @@ template $CcScreenPage: Adw.NavigationPage {
           use-underline: true;
         }
 
+        Adw.SwitchRow lock_on_suspend_row {
+          title: _("Lock Screen _on Suspend");
+          use-underline: true;
+        }
+
         Adw.SwitchRow usb_protection_row {
           visible: false;
           title: _("Forbid New _USB Devices");
diff --git a/panels/privacy/screen/cc-screen-page.c b/panels/privacy/screen/cc-screen-page.c
index ddb0a88..2b6882e 100644
--- a/panels/privacy/screen/cc-screen-page.c
+++ b/panels/privacy/screen/cc-screen-page.c
@@ -45,6 +45,7 @@ struct _CcScreenPage
   AdwPreferencesGroup *screen_privacy_group;
   GDBusProxy          *usb_proxy;
   AdwSwitchRow        *automatic_screen_lock_row;
+  AdwSwitchRow        *lock_on_suspend_row;
   AdwSwitchRow        *privacy_screen_row;
   AdwSwitchRow        *show_notifications_row;
   AdwSwitchRow        *usb_protection_row;
@@ -136,6 +137,7 @@ cc_screen_page_class_init (CcScreenPageClass *klass)
   gtk_widget_class_bind_template_child (widget_class, CcScreenPage, automatic_screen_lock_row);
   gtk_widget_class_bind_template_child (widget_class, CcScreenPage, blank_screen_row);
   gtk_widget_class_bind_template_child (widget_class, CcScreenPage, lock_after_row);
+  gtk_widget_class_bind_template_child (widget_class, CcScreenPage, lock_on_suspend_row);
   gtk_widget_class_bind_template_child (widget_class, CcScreenPage, privacy_screen_row);
   gtk_widget_class_bind_template_child (widget_class, CcScreenPage, screen_privacy_group);
   gtk_widget_class_bind_template_child (widget_class, CcScreenPage, show_notifications_row);
@@ -177,6 +179,8 @@ update_display_config (CcScreenPage *self)
 static void
 cc_screen_page_init (CcScreenPage *self)
 {
+  g_autoptr(GSettingsSchema) schema = NULL;
+
   gtk_widget_init_template (GTK_WIDGET (self));
 
   self->cancellable = g_cancellable_new ();
@@ -186,6 +190,8 @@ cc_screen_page_init (CcScreenPage *self)
   self->notification_settings = g_settings_new ("org.gnome.desktop.notifications");
   self->session_settings = g_settings_new ("org.gnome.desktop.session");
 
+  g_object_get (self->lock_settings, "settings-schema", &schema, NULL);
+
   g_settings_bind (self->lock_settings,
                    "lock-enabled",
                    self->automatic_screen_lock_row,
@@ -230,6 +236,20 @@ cc_screen_page_init (CcScreenPage *self)
                    "active",
                    G_SETTINGS_BIND_DEFAULT);
 
+  if (g_settings_schema_has_key (schema, "ubuntu-lock-on-suspend"))
+    {
+      g_settings_bind (self->lock_settings,
+                       "ubuntu-lock-on-suspend",
+                       self->lock_on_suspend_row,
+                       "active",
+                       G_SETTINGS_BIND_DEFAULT);
+    }
+  else
+    {
+      g_warning ("No ubuntu-lock-on-suspend settings key found");
+      gtk_widget_set_visible (GTK_WIDGET (self->lock_on_suspend_row), FALSE);
+    }
+
   g_dbus_proxy_new_for_bus (G_BUS_TYPE_SESSION,
                             G_DBUS_PROXY_FLAGS_NONE,
                             NULL,
